name: Tests

on: [push]

jobs:
  run-tests:
    runs-on: ubuntu-18.04
    steps:
    - name: Install Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'
        architecture: 'x64'

    - name: Install Dependencies
      run: |
        python -m pip install -U pip
        pip install -U pytest selenium flake8 pylint

    - name: Check out and download repository
      uses: actions/checkout@v2

    - name: Check code
      run: |
        flake8 --exit-zero Tests/test_main.py
        pylint --errors-only Tests/test_main.py

    - name: Start Selenoid
      run: |
        wget --no-check-certificate -O cm https://github.com/aerokube/cm/releases/latest/download/cm_linux_amd64
        chmod +x cm
        ./cm selenoid start --browsers 'firefox;chrome;opera;android' --last-versions 1
        curl http://localhost:4444/status

    - name: Run tests Firefox
      run: |
        pytest --browser_name=firefox Tests/test_main.py
      continue-on-error: true
    
    - name: Run tests Chrome
      run: |
        pytest --alluredir=allure-results --browser_name=chrome Tests/test_main.py
      continue-on-error: true
    
    - name: Run tests Opera
      run: |
        pytest --browser_name=opera Tests/test_main.py
      continue-on-error: true

    - name: Run tests Android
      run: |
        pytest --browser_name=android Tests/test_main.py
      continue-on-error: true

    - name: Get Allure history
      uses: actions/checkout@v2
      if: always()
      continue-on-error: true
      with:
        ref: gh-pages
        path: gh-pages

    - name: Allure Report action from marketplace
      uses: simple-elf/allure-report-action@master
      if: always()
      #id: allure-report
      with:
        allure_results: allure-results
        #gh_pages: gh-pages
        #allure_report: allure-report
        allure_history: allure-history

    - name: Deploy report to Github pages
      if: always()
      uses: peaceiris/actions-gh-pages@v2
      env:
        PERSONAL_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PUBLISH_BRANCH: gh-pages
        PUBLISH_DIR: allure-history